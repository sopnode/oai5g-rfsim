# expected jinja variables, set by calling python script
# {{gateway}} - typically 'faraday.inria.fr'
# {{leader}} - typically 'sopnode-l1.inria.fr'
# {{namespace}} - typically 'oai5g'
# {{nodes}} - typically {'amf': 'fit01', 'spgwu': 'fit02', 'gnb' : 'fit03', 'ue': 'fit04'}
# {{image}} - typically 'kubernetes'
# {{verbose}} - typically 'True' or "False"

nodes:
  - id: faraday
    hostname: {{gateway}}
    formatter: TimeColonFormatter
    verbose: {{verbose}}
  - id: leader
    hostname: {{leader}}
    gateway: faraday
    username: r2lab
    formatter: TimeColonFormatter
    verbose: {{verbose}}
  {% for function, hostname in nodes.items() %}
  - id: {{function}}
    hostname: {{hostname}}
    gateway: faraday
    username: root
    formatter: TimeColonFormatter
    verbose: {{verbose}}
  {% endfor %}

jobs:
  - id: load_images
    node: faraday
    critical: True
    verbose: {{verbose}}
    label: load image {{image}} on FIT worker nodes
    commands:
      - type: Run
        command: >
          rhubarbe load -i {{image}} {%for h in nodes.values()%}{{h}} {% endfor %}
      - type: Run
        command: >
          rhubarbe wait {%for h in nodes.values()%}{{h}} {% endfor %}

  # for now, useless to switch off other nodes as we use RfSimulator
  # - id: turn_off_others
  #   node: faraday
  #   critical: False
  #   verbose: {{verbose}}
  #   label: turn off unused nodes
  #   commands:
  #   - type: Run
  #     command: >
  #       rhubarbe bye -- {% for h in nodes.values() %}~{{h}} {% endfor %}
  #   - type: Run
  #     command: sleep 1
  #
  {% for function, hostname in nodes.items() %}
  - id: leave_join_{{function}}
    required: load_images
    node: {{function}}
    critical: False
    verbose: {{verbose}}
    label: >
      Prepare node {{function}} on {{hostname}} for k8s & networking
    commands:
      - type: Run
        command: nmcli con down data; nmcli dev status; leave-tunnel
      - type: Run
        command: kube-install.sh leave-cluster
      - type: Run
        command: sleep 60
      - type: Run
        command: nmcli con up data; nmcli dev status; join-tunnel
      - type: Run
        command: kube-install.sh join-cluster r2lab@{{leader}}
  {% endfor %}

  - id: init_demo
    required:
      {% for function in nodes.keys() %}
      - leave_join_{{function}}
      {% endfor %}
    node: amf
    critical: True
    verbose: {{verbose}}
    label: >
      Clone oai-cn5g-fed, apply patches
      and run the k8s demo-oai script from {{nodes.amf}}
    commands:
      - type: Run
        command: >
          rm -rf oai-cn5g-fed;
          git clone -b master https://gitlab.eurecom.fr/oai/cn5g/oai-cn5g-fed
      - type: RunScript
        command: config-oai5g-sopnode.sh {%for h in nodes.values()%}{{h}} {% endfor %}
      - type: RunScript
        command: demo-oai.sh init

  - id: start_demo
    required: init_demo
    node: amf
    critical: True
    verbose: {{verbose}}
    label: >
      Launch OAI5G pods by calling demo-oai.sh start from {{amf}}
    commands:
      - type: RunScript
        command: demo-oai.sh start {{namespace}} {%for h in nodes.values()%}{{h}} {% endfor %}

  - id: stop_demo
    required: start_demo
    node: amf
    critical: True
    verbose: {{verbose}}
    label: >
      Delete OAI5G pods by calling demo-oai.sh stop from {{nodes.amf}}
    commands:
      - type: RunScript
        command: demo-oai.sh stop {{namespace}}

  - id: cleanup1
    required: stop_demo
    node: leader
    critical: False
    verbose: {{verbose}}
    label: Drain and delete FIT nodes from the k8s {{leader}} cluster
    commands:
      - type: Run
        command: fit-drain-nodes; fit-delete-nodes

  - id: cleanup2
    required: stop_demo
    node: faraday
    critical: False
    verbose: {{verbose}}
    commands:
      - type: Run
        command: rhubarbe off {%for h in nodes.values()%}{{h}} {% endfor %}
